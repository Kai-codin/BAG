"use strict";
/** Rail Announcements Generator. By Roy Curtis, MIT license, 2018 */
exports.__esModule = true;
var voxEditor_1 = require("./voxEditor");
/** Generates a bank of IDs and captions from a given phraseset document and data */
var Captioner = /** @class */ (function () {
    function Captioner() {
        /** Reference to the generated phrase caption bank */
        this.captionBank = {};
        this.populateLetters();
        this.populateNumbers();
        this.populateExcuses();
        this.populatePhrasesets();
        this.populateNames();
        this.populateServices();
        this.populateStations();
        console.log(Object.keys(this.captionBank).length);
    }
    /** TreeWalker filter to only accept text nodes */
    Captioner.prototype.nodeFilter = function (node) {
        // Only accept text nodes with words in them
        if (node.textContent.match(/[a-z0-9]/i))
            return NodeFilter.FILTER_ACCEPT;
        return NodeFilter.FILTER_REJECT;
    };
    Captioner.prototype.populateLetters = function () {
        // TODO: After moving letters out of I18n, fix this
        var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        for (var i = 0; i < letters.length; i++) {
            var letter = letters[i];
            this.captionBank["letter." + letter] = letter;
        }
    };
    Captioner.prototype.populateNumbers = function () {
        // Single digits
        for (var n = 0; n <= 60; n++)
            this.captionBank["number." + n] = n.toString();
        // 24 hour double digits
        for (var n = 1; n <= 9; n++)
            this.captionBank["number.0" + n] = "Oh-" + n;
        // 00:MM
        this.captionBank["number.00"] = 'Oh-oh';
        // 00:00
        this.captionBank["number.0000"] = 'Oh-zero hundred';
        // "Hundred"
        this.captionBank['number.hundred'] = 'Hundred';
    };
    Captioner.prototype.populateExcuses = function () {
        for (var i = 0; i < voxEditor_1.VoxEditor.database.excuses.length; i++)
            this.captionBank["excuse." + i] = voxEditor_1.VoxEditor.database.excuses[i];
    };
    /** Walks through every XML element and populates the caption bank from phrasesets */
    Captioner.prototype.populatePhrasesets = function () {
        var treeWalker = document.createTreeWalker(voxEditor_1.VoxEditor.database.phrasesets, NodeFilter.SHOW_TEXT, { acceptNode: this.nodeFilter }, false);
        var lastId = '';
        var lastIdx = 0;
        while (treeWalker.nextNode()) {
            var current = treeWalker.currentNode;
            var parent_1 = current.parentElement;
            var psIndex = -1;
            var id = '';
            var value = Strings.clean(current.textContent);
            // If text is part of a phraseset, get index of the phrase within the set
            if (!parent_1.hasAttribute('id')) {
                var phraseSet = parent_1.parentElement;
                // https://stackoverflow.com/a/9132575/3354920
                psIndex = Array.prototype.indexOf.call(phraseSet.children, parent_1);
                parent_1 = phraseSet;
            }
            // Calculate ID by getting relative indicies of phrases and text parts
            id = 'phrase.' + parent_1.id;
            // Append phrase index if we're in a phraseset
            if (psIndex !== -1)
                id += "." + psIndex;
            // Append the text part's index inside the phrase
            if (lastId !== id) {
                lastIdx = 0;
                lastId = id;
            }
            id += "." + lastIdx++;
            // Append a "preview" of the next sibling to the text
            if (current.nextSibling) {
                var next = current.nextSibling;
                var tag = next.nodeName.toUpperCase();
                // Append extra reference data to tag
                if (next.id)
                    tag += ':' + next.id;
                else if (next.hasAttribute('context'))
                    tag += ':' + next.getAttribute('context');
                else if (next.hasAttribute('ref'))
                    tag += ':' + next.getAttribute('ref');
                value += " <" + tag + ">";
            }
            this.captionBank[id] = value;
        }
    };
    Captioner.prototype.populateNames = function () {
        for (var i = 0; i < voxEditor_1.VoxEditor.database.named.length; i++)
            this.captionBank["named." + i] = voxEditor_1.VoxEditor.database.named[i];
    };
    Captioner.prototype.populateServices = function () {
        for (var i = 0; i < voxEditor_1.VoxEditor.database.services.length; i++)
            this.captionBank["services." + i] = voxEditor_1.VoxEditor.database.services[i];
    };
    Captioner.prototype.populateStations = function () {
        var _this = this;
        // Filter out parenthesized location context
        var filter = function (v) { return v.replace(/\(.+\)/i, '').trim(); };
        var stations = voxEditor_1.VoxEditor.database.stations;
        var keys = Object.keys(stations);
        keys.forEach(function (k) {
            return _this.captionBank["stations.middle." + k] = filter(stations[k]);
        });
        keys.forEach(function (k) {
            return _this.captionBank["stations.end." + k] = filter(stations[k]);
        });
    };
    return Captioner;
}());
exports.Captioner = Captioner;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FwdGlvbmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NhcHRpb25lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUVBQXFFOztBQUVyRSx5Q0FBc0M7QUFLdEMsb0ZBQW9GO0FBQ3BGO0lBS0k7UUFIQSxxREFBcUQ7UUFDckMsZ0JBQVcsR0FBb0IsRUFBRSxDQUFDO1FBSTlDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUV4QixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxrREFBa0Q7SUFDMUMsOEJBQVUsR0FBbEIsVUFBbUIsSUFBVTtRQUV6Qiw0Q0FBNEM7UUFDNUMsSUFBSSxJQUFJLENBQUMsV0FBWSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7WUFDcEMsT0FBTyxVQUFVLENBQUMsYUFBYSxDQUFDO1FBRXBDLE9BQU8sVUFBVSxDQUFDLGFBQWEsQ0FBQztJQUNwQyxDQUFDO0lBRU8sbUNBQWUsR0FBdkI7UUFFSSxtREFBbUQ7UUFDbkQsSUFBSSxPQUFPLEdBQUcsNEJBQTRCLENBQUM7UUFFM0MsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQ3ZDO1lBQ0ksSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXhCLElBQUksQ0FB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QUcsQ0FBQyxHQUFHLHFCQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBRU8sb0NBQWdCLEdBQXhCO1FBQUEsaUJBY0M7UUFaRyw0Q0FBNEM7UUFDNUMsSUFBSSxNQUFNLEdBQUssVUFBQyxDQUFTLElBQUssT0FBQSxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBL0IsQ0FBK0IsQ0FBQztRQUM5RCxJQUFJLFFBQVEsR0FBRyxxQkFBUyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFDM0MsSUFBSSxJQUFJLEdBQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVyQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQUEsQ0FBQztZQUNWLE9BQUEsS0FBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBbUIsQ0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUE5RCxDQUE4RCxDQUNqRSxDQUFDO1FBRUYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7WUFDVixPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWdCLENBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFBM0QsQ0FBMkQsQ0FDOUQsQ0FBQztJQUNOLENBQUM7SUFDTCxnQkFBQztBQUFELENBQUMsQUFsS0QsSUFrS0M7QUFsS1ksOEJBQVMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogUmFpbCBBbm5vdW5jZW1lbnRzIEdlbmVyYXRvci4gQnkgUm95IEN1cnRpcywgTUlUIGxpY2Vuc2UsIDIwMTggKi9cclxuXHJcbmltcG9ydCB7Vm94RWRpdG9yfSBmcm9tIFwiLi92b3hFZGl0b3JcIjtcclxuXHJcbi8qKiBSZXByZXNlbnRzIGEgZGljdGlvbmFyeSBvZiB2b2ljZSBrZXlzIGFuZCB0aGVpciBjYXB0aW9ucyAqL1xyXG5leHBvcnQgdHlwZSBQaHJhc2VDYXB0aW9ucyA9IHtbaWQ6IHN0cmluZ10gOiBzdHJpbmd9O1xyXG5cclxuLyoqIEdlbmVyYXRlcyBhIGJhbmsgb2YgSURzIGFuZCBjYXB0aW9ucyBmcm9tIGEgZ2l2ZW4gcGhyYXNlc2V0IGRvY3VtZW50IGFuZCBkYXRhICovXHJcbmV4cG9ydCBjbGFzcyBDYXB0aW9uZXJcclxue1xyXG4gICAgLyoqIFJlZmVyZW5jZSB0byB0aGUgZ2VuZXJhdGVkIHBocmFzZSBjYXB0aW9uIGJhbmsgKi9cclxuICAgIHB1YmxpYyByZWFkb25seSBjYXB0aW9uQmFuayA6IFBocmFzZUNhcHRpb25zID0ge307XHJcblxyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKClcclxuICAgIHtcclxuICAgICAgICB0aGlzLnBvcHVsYXRlTGV0dGVycygpO1xyXG4gICAgICAgIHRoaXMucG9wdWxhdGVOdW1iZXJzKCk7XHJcbiAgICAgICAgdGhpcy5wb3B1bGF0ZUV4Y3VzZXMoKTtcclxuICAgICAgICB0aGlzLnBvcHVsYXRlUGhyYXNlc2V0cygpO1xyXG4gICAgICAgIHRoaXMucG9wdWxhdGVOYW1lcygpO1xyXG4gICAgICAgIHRoaXMucG9wdWxhdGVTZXJ2aWNlcygpO1xyXG4gICAgICAgIHRoaXMucG9wdWxhdGVTdGF0aW9ucygpO1xyXG5cclxuICAgICAgICBjb25zb2xlLmxvZyhPYmplY3Qua2V5cyh0aGlzLmNhcHRpb25CYW5rKS5sZW5ndGgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiBUcmVlV2Fsa2VyIGZpbHRlciB0byBvbmx5IGFjY2VwdCB0ZXh0IG5vZGVzICovXHJcbiAgICBwcml2YXRlIG5vZGVGaWx0ZXIobm9kZTogTm9kZSk6IG51bWJlclxyXG4gICAge1xyXG4gICAgICAgIC8vIE9ubHkgYWNjZXB0IHRleHQgbm9kZXMgd2l0aCB3b3JkcyBpbiB0aGVtXHJcbiAgICAgICAgaWYgKG5vZGUudGV4dENvbnRlbnQhLm1hdGNoKC9bYS16MC05XS9pKSlcclxuICAgICAgICAgICAgcmV0dXJuIE5vZGVGaWx0ZXIuRklMVEVSX0FDQ0VQVDtcclxuXHJcbiAgICAgICAgcmV0dXJuIE5vZGVGaWx0ZXIuRklMVEVSX1JFSkVDVDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHBvcHVsYXRlTGV0dGVycygpIDogdm9pZFxyXG4gICAge1xyXG4gICAgICAgIC8vIFRPRE86IEFmdGVyIG1vdmluZyBsZXR0ZXJzIG91dCBvZiBJMThuLCBmaXggdGhpc1xyXG4gICAgICAgIGxldCBsZXR0ZXJzID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaJztcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZXR0ZXJzLmxlbmd0aDsgaSsrKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgbGV0IGxldHRlciA9IGxldHRlcnNbaV07XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNhcHRpb25CYW5rW2BsZXR0ZXIuJHtsZXR0ZXJ9YF0gPSBsZXR0ZXI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcG9wdWxhdGVOdW1iZXJzKCkgOiB2b2lkXHJcbiAgICB7XHJcbiAgICAgICAgLy8gU2luZ2xlIGRpZ2l0c1xyXG4gICAgICAgIGZvciAobGV0IG4gPSAwOyBuIDw9IDYwOyBuKyspXHJcbiAgICAgICAgICAgIHRoaXMuY2FwdGlvbkJhbmtbYG51bWJlci4ke259YF0gPSBuLnRvU3RyaW5nKCk7XHJcblxyXG4gICAgICAgIC8vIDI0IGhvdXIgZG91YmxlIGRpZ2l0c1xyXG4gICAgICAgIGZvciAobGV0IG4gPSAxOyBuIDw9IDk7IG4rKylcclxuICAgICAgICAgICAgdGhpcy5jYXB0aW9uQmFua1tgbnVtYmVyLjAke259YF0gPSBgT2gtJHtufWA7XHJcblxyXG4gICAgICAgIC8vIDAwOk1NXHJcbiAgICAgICAgdGhpcy5jYXB0aW9uQmFua1tgbnVtYmVyLjAwYF0gPSAnT2gtb2gnO1xyXG5cclxuICAgICAgICAvLyAwMDowMFxyXG4gICAgICAgIHRoaXMuY2FwdGlvbkJhbmtbYG51bWJlci4wMDAwYF0gPSAnT2gtemVybyBodW5kcmVkJztcclxuXHJcbiAgICAgICAgLy8gXCJIdW5kcmVkXCJcclxuICAgICAgICB0aGlzLmNhcHRpb25CYW5rWydudW1iZXIuaHVuZHJlZCddID0gJ0h1bmRyZWQnO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcG9wdWxhdGVFeGN1c2VzKCkgOiB2b2lkXHJcbiAgICB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBWb3hFZGl0b3IuZGF0YWJhc2UuZXhjdXNlcy5sZW5ndGg7IGkrKylcclxuICAgICAgICAgICAgdGhpcy5jYXB0aW9uQmFua1tgZXhjdXNlLiR7aX1gXSA9IFZveEVkaXRvci5kYXRhYmFzZS5leGN1c2VzW2ldO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiBXYWxrcyB0aHJvdWdoIGV2ZXJ5IFhNTCBlbGVtZW50IGFuZCBwb3B1bGF0ZXMgdGhlIGNhcHRpb24gYmFuayBmcm9tIHBocmFzZXNldHMgKi9cclxuICAgIHByaXZhdGUgcG9wdWxhdGVQaHJhc2VzZXRzKCkgOiB2b2lkXHJcbiAgICB7XHJcbiAgICAgICAgbGV0IHRyZWVXYWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKFxyXG4gICAgICAgICAgICBWb3hFZGl0b3IuZGF0YWJhc2UucGhyYXNlc2V0cyxcclxuICAgICAgICAgICAgTm9kZUZpbHRlci5TSE9XX1RFWFQsXHJcbiAgICAgICAgICAgIHsgYWNjZXB0Tm9kZTogdGhpcy5ub2RlRmlsdGVyIH0sXHJcbiAgICAgICAgICAgIGZhbHNlXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgbGV0IGxhc3RJZCAgPSAnJztcclxuICAgICAgICBsZXQgbGFzdElkeCA9IDA7XHJcblxyXG4gICAgICAgIHdoaWxlICggdHJlZVdhbGtlci5uZXh0Tm9kZSgpIClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGxldCBjdXJyZW50ID0gdHJlZVdhbGtlci5jdXJyZW50Tm9kZTtcclxuICAgICAgICAgICAgbGV0IHBhcmVudCAgPSBjdXJyZW50LnBhcmVudEVsZW1lbnQhO1xyXG4gICAgICAgICAgICBsZXQgcHNJbmRleCA9IC0xO1xyXG4gICAgICAgICAgICBsZXQgaWQgICAgICA9ICcnO1xyXG4gICAgICAgICAgICBsZXQgdmFsdWUgICA9IFN0cmluZ3MuY2xlYW4oY3VycmVudC50ZXh0Q29udGVudCEpO1xyXG5cclxuICAgICAgICAgICAgLy8gSWYgdGV4dCBpcyBwYXJ0IG9mIGEgcGhyYXNlc2V0LCBnZXQgaW5kZXggb2YgdGhlIHBocmFzZSB3aXRoaW4gdGhlIHNldFxyXG4gICAgICAgICAgICBpZiAoICFwYXJlbnQuaGFzQXR0cmlidXRlKCdpZCcpIClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgbGV0IHBocmFzZVNldCA9IHBhcmVudC5wYXJlbnRFbGVtZW50ITtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvOTEzMjU3NS8zMzU0OTIwXHJcbiAgICAgICAgICAgICAgICBwc0luZGV4ID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChwaHJhc2VTZXQuY2hpbGRyZW4sIHBhcmVudCk7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQgID0gcGhyYXNlU2V0O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgSUQgYnkgZ2V0dGluZyByZWxhdGl2ZSBpbmRpY2llcyBvZiBwaHJhc2VzIGFuZCB0ZXh0IHBhcnRzXHJcbiAgICAgICAgICAgIGlkID0gJ3BocmFzZS4nICsgcGFyZW50LmlkO1xyXG5cclxuICAgICAgICAgICAgLy8gQXBwZW5kIHBocmFzZSBpbmRleCBpZiB3ZSdyZSBpbiBhIHBocmFzZXNldFxyXG4gICAgICAgICAgICBpZiAocHNJbmRleCAhPT0gLTEpXHJcbiAgICAgICAgICAgICAgICBpZCArPSBgLiR7cHNJbmRleH1gO1xyXG5cclxuICAgICAgICAgICAgLy8gQXBwZW5kIHRoZSB0ZXh0IHBhcnQncyBpbmRleCBpbnNpZGUgdGhlIHBocmFzZVxyXG4gICAgICAgICAgICBpZiAobGFzdElkICE9PSBpZClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgbGFzdElkeCA9IDA7XHJcbiAgICAgICAgICAgICAgICBsYXN0SWQgID0gaWQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlkICs9IGAuJHtsYXN0SWR4Kyt9YDtcclxuXHJcbiAgICAgICAgICAgIC8vIEFwcGVuZCBhIFwicHJldmlld1wiIG9mIHRoZSBuZXh0IHNpYmxpbmcgdG8gdGhlIHRleHRcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnQubmV4dFNpYmxpbmcpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGxldCBuZXh0ID0gY3VycmVudC5uZXh0U2libGluZyBhcyBIVE1MRWxlbWVudDtcclxuICAgICAgICAgICAgICAgIGxldCB0YWcgID0gbmV4dC5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIEFwcGVuZCBleHRyYSByZWZlcmVuY2UgZGF0YSB0byB0YWdcclxuICAgICAgICAgICAgICAgIGlmICAgICAgKG5leHQuaWQpXHJcbiAgICAgICAgICAgICAgICAgICAgdGFnICs9ICc6JyArIG5leHQuaWQ7XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChuZXh0Lmhhc0F0dHJpYnV0ZSgnY29udGV4dCcpKVxyXG4gICAgICAgICAgICAgICAgICAgIHRhZyArPSAnOicgKyBuZXh0LmdldEF0dHJpYnV0ZSgnY29udGV4dCcpO1xyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobmV4dC5oYXNBdHRyaWJ1dGUoJ3JlZicpKVxyXG4gICAgICAgICAgICAgICAgICAgIHRhZyArPSAnOicgKyBuZXh0LmdldEF0dHJpYnV0ZSgncmVmJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFsdWUgKz0gYCA8JHt0YWd9PmA7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuY2FwdGlvbkJhbmtbaWRdID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcG9wdWxhdGVOYW1lcygpIDogdm9pZFxyXG4gICAge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgVm94RWRpdG9yLmRhdGFiYXNlLm5hbWVkLmxlbmd0aDsgaSsrKVxyXG4gICAgICAgICAgICB0aGlzLmNhcHRpb25CYW5rW2BuYW1lZC4ke2l9YF0gPSBWb3hFZGl0b3IuZGF0YWJhc2UubmFtZWRbaV07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwb3B1bGF0ZVNlcnZpY2VzKCkgOiB2b2lkXHJcbiAgICB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBWb3hFZGl0b3IuZGF0YWJhc2Uuc2VydmljZXMubGVuZ3RoOyBpKyspXHJcbiAgICAgICAgICAgIHRoaXMuY2FwdGlvbkJhbmtbYHNlcnZpY2VzLiR7aX1gXSA9IFZveEVkaXRvci5kYXRhYmFzZS5zZXJ2aWNlc1tpXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHBvcHVsYXRlU3RhdGlvbnMoKSA6IHZvaWRcclxuICAgIHtcclxuICAgICAgICAvLyBGaWx0ZXIgb3V0IHBhcmVudGhlc2l6ZWQgbG9jYXRpb24gY29udGV4dFxyXG4gICAgICAgIGxldCBmaWx0ZXIgICA9ICh2OiBzdHJpbmcpID0+IHYucmVwbGFjZSgvXFwoLitcXCkvaSwgJycpLnRyaW0oKTtcclxuICAgICAgICBsZXQgc3RhdGlvbnMgPSBWb3hFZGl0b3IuZGF0YWJhc2Uuc3RhdGlvbnM7XHJcbiAgICAgICAgbGV0IGtleXMgICAgID0gT2JqZWN0LmtleXMoc3RhdGlvbnMpO1xyXG5cclxuICAgICAgICBrZXlzLmZvckVhY2goayA9PlxyXG4gICAgICAgICAgICB0aGlzLmNhcHRpb25CYW5rW2BzdGF0aW9ucy5taWRkbGUuJHtrfWBdID0gZmlsdGVyKHN0YXRpb25zW2tdKVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGtleXMuZm9yRWFjaChrID0+XHJcbiAgICAgICAgICAgIHRoaXMuY2FwdGlvbkJhbmtbYHN0YXRpb25zLmVuZC4ke2t9YF0gPSBmaWx0ZXIoc3RhdGlvbnNba10pXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxufSJdfQ==